import os
import sys
import time
import requests
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.common.exceptions import TimeoutException
from selenium.webdriver.support import expected_conditions as EC
from steam import Steam
from datetime import datetime, timedelta
from langdetect import detect
import xlsxwriter
import math
from decouple import config
from enum import Enum
class WorkshopItem:
    def __init__(self, title, creator_ID, creator_name, country, detected_language, date_posted, tags, item_type):
        self.title = title
        self.creator_ID = creator_ID
        self.creator_name = creator_name
        self.detected_language = detected_language
        self.country = country
        self.date_posted = date_posted
        self.tags = tags
        self.item_type = item_type
def user_define_date_range():
    week_defined = False
    while week_defined == False:
        print('\n\n')
        year = int(input("Enter the year: "))
        first_monday = datetime(year, 1, 1)
        while first_monday.weekday() != 0:
            first_monday += timedelta(days=1)
        week = int(input("Enter the week: "))
        start_date = first_monday + timedelta(weeks=week-1)
        end_date = start_date + timedelta(days=6, hours=23, minutes=59, seconds=59)
        result = input(f"Start date: {start_date}\nEnd date: {end_date}\n'Y' to continue, 'N' to re-enter:")
        if result.lower() == 'y':
            week_defined = True
    return start_date,end_date, week
def user_define_filter():
    result = ''
    while result == '':
        print('\n\n')
        print('Press L to search for levels')
        print('Press M to search for models')
        print('Press W to search entire workshop content for the week')
        result = input("Enter your choice: ")
        if result.lower() == 'l':   
            return 'Levels'
        elif result.lower() == 'm':
            return 'Models'
        elif result.lower() == 'w':
            return 'Workshop'
        else:
            result = ''
            print("Invalid input. Please try again.")
    return result
def get_workshop_link(start_date, end_date, filter):
    if filter == 'Workshop':
        link = f"https://steamcommunity.com/workshop/browse/?appid=477160&searchtext=&childpublishedfileid=0&browsesort=mostrecent&section=readytouseitems&created_date_range_filter_start={start_date.timestamp()}&created_date_range_filter_end={end_date.timestamp()}&updated_date_range_filter_start=0&updated_date_range_filter_end=0&p=1"
    elif filter == 'Levels':
        link = f"https://steamcommunity.com/workshop/browse/?appid=477160&searchtext=&childpublishedfileid=0&browsesort=mostrecent&section=readytouseitems&requiredtags%5B%5D=Levels&created_date_range_filter_start={round(start_date.timestamp())}&created_date_range_filter_end={end_date.timestamp()}&updated_date_range_filter_start=NaN&updated_date_range_filter_end=NaN&p=1"
    elif filter == 'Models':
        link = f"https://steamcommunity.com/workshop/browse/?appid=477160&searchtext=&childpublishedfileid=0&browsesort=mostrecent&section=readytouseitems&requiredtags%5B%5D=Model&created_date_range_filter_start={round(start_date.timestamp)}&created_date_range_filter_end={end_date.timestamp}&updated_date_range_filter_start=NaN&updated_date_range_filter_end=NaN&p=1"
    return link
def get_expected_number_of_items():
    try:
        wait.until(lambda driver: len(driver.find_elements(By.CSS_SELECTOR, 'div.workshopBrowsePagingInfo')) > 0)
    except TimeoutException:
        print("Could not find expected number of items.")
        return 0
    number_of_items_string = driver.find_element(By.CSS_SELECTOR, 'div.workshopBrowsePagingInfo').text
    expected_number_of_items = int(number_of_items_string.split('of ')[1].split(' ')[0].replace(',', ''))
    return expected_number_of_items
def next_page():
    currentPageUrl = driver.current_url
    currentPage = int(currentPageUrl.split('p=')[1])
    nextPage = currentPage + 1
    nextPageUrl = currentPageUrl.split('p=')[0] + 'p=' + str(nextPage)
    driver.get(nextPageUrl)
def get_workshop_css_elements():
    try:
        wait.until(lambda driver: len(driver.find_elements(By.CSS_SELECTOR, 'div.workshopItem')) > 0)
    except TimeoutException:
        print("Timed out waiting for page to load")
        return []
    workshop_css_elements = driver.find_elements(By.CSS_SELECTOR, 'div.workshopItem')
    return workshop_css_elements
def get_steam_data_from_workshop_css_element(item):
    params = {
            'key': KEY,
            'itemcount': 1,
            'publishedfileids[0]': item.find_element(By.CSS_SELECTOR, 'a').get_attribute('data-publishedfileid')
        }
    response = requests.post(url, data=params)
    data = response.json()
    workShopItem = data['response']['publishedfiledetails'][0]
    print(workShopItem["publishedfileid"])
    user = steam.users.get_user_details(data['response']['publishedfiledetails'][0]['creator'])
    return workShopItem, user
def create_workshop_item_objects_array(workshop_css_elements):
    workshopItems = []
    for workshop_css_element in workshop_css_elements:
        workshop_item, user = get_steam_data_from_workshop_css_element(workshop_css_element)
        #Get Title of workshop item
        title = workshop_item['title']
        #Get AuthorID of workshop item
        creator_id = workshop_item['creator']
        #Get Author Name of workshop item
        creator_name = user['player']['personaname']
        #Get Country of Author
        country = get_user_country(user)
        #Get language of workshop item
        detected_language = get_langauge_from_user_and_item(user, workshop_item)
        #Get date posted of workshop item
        date_posted = datetime.fromtimestamp(workshop_item['time_created'])
        #Get tags of workshop item
        tags = get_tags(workshop_item['tags'])
        #Get type of workshop item ("Model" or "Level")
        item_type = get_item_type_from_tags(tags)
        #create a new workshop item object and append it to list.
        workshopItems.append(WorkshopItem(title, creator_id, creator_name, country, detected_language, date_posted, tags, item_type))
    return workshopItems
def get_user_country(user):
    if('loccountrycode' in user['player']):
        return user['player']['loccountrycode']
    else:
        return "N/A"
def get_langauge_from_user_and_item(user, workshop_item):
    #chinese override, if the user's country is already display as China, then the language is Chinese
    if(get_user_country(user) == 'CN'):
        return 'zh-cn'
    strings = []
    if user is None:
        pass
    else:
        if('personaname' in user['player']):
            strings.append(user['player']['personaname'])
        if('realname' in user['player']):
            strings.append(user['player']['realname'])
        if('bio' in user['player']):
            strings.append(user['player']['bio'])
    if workshop_item is None:
        pass
    else:
        if('title' in workshop_item):
            strings.append(workshop_item['title'])
        if('description' in workshop_item):
            strings.append(workshop_item['description'])
    newString = ""
    for string in strings:
        newString = newString + ", " + string
    try:
        detected_language = detect(newString)
    except:
        detected_language = "N/A"

    #Chinese override (Example: if a player has a chinese username, but is using english in title/description of the item,
    #the language might be detected as english, but we want to override that and set it to chinese)
    if 'zh' not in detected_language:
        for string in strings:
            try:
                if 'zh' in detect(string):
                    detected_language = 'zh-cn'
                    break
            except:
                continue
    return detected_language
def get_tags(tags):
    tag_strings = [tag['tag'] for tag in tags]
    tag_string = ', '.join(tag_strings)
    return tag_string
def get_item_type_from_tags(tags):
    if('Model' in tags):
        return "Model"
    elif('Levels' in tags):
        return "Level"
    elif('Lobbies' in tags):
        return "Lobby"
    else:
        return "N/A"
def write_to_excel(start_date, end_date, week, workshop_data):
    workbook = xlsxwriter.Workbook(f'UGCChineseSpeakingCount_Week{week}_{start_date.strftime("%m-%d-%Y")}_to_{end_date.strftime("%m-%d-%Y")}.xlsx')
    worksheet = workbook.add_worksheet()
    worksheet.write('A1', 'Date Posted')
    worksheet.write('B1', 'Title')
    worksheet.write('C1', 'Creator Name')
    worksheet.write('D1', 'Type')
    worksheet.write('E1', 'Country')
    worksheet.write('F1', 'Language')

    chineseLevels = 0
    chineseModels = 0
    totalLevels = 0
    totalModels = 0
    for(i, item) in enumerate(workshop_data):
        worksheet.write(i+1, 0, item.date_posted.strftime("%d-%m-%Y"))
        worksheet.write(i+1, 1, item.title)
        worksheet.write(i+1, 2, item.creator_name)
        worksheet.write(i+1, 3, item.item_type)
        worksheet.write(i+1, 4, item.country)
        worksheet.write(i+1, 5, item.detected_language)
        if item.detected_language == 'zh-cn':
            if item.item_type == 'Level':
                chineseLevels += 1
            elif item.item_type == 'Model':
                chineseModels += 1
        if item.item_type == 'Level':
            totalLevels += 1
        elif item.item_type == 'Model':
            totalModels += 1
    worksheet.write('H2', 'Models')
    worksheet.write('H3', 'Total Entries')
    worksheet.write('H4', 'Chinese Entries')
    worksheet.write('H5', 'Chinese Proportion')

    worksheet.write('H7', 'Levels')
    worksheet.write('H8', 'Total Entries')
    worksheet.write('H9', 'Chinese Entries')
    worksheet.write('H10', 'Chinese Proportion')

    worksheet.write('H12', 'Total')
    worksheet.write('H13', 'Total Entries')
    worksheet.write('H14', 'Chinese Entries')
    worksheet.write('H15', 'Chinese Proportion')

    worksheet.write('I3', totalModels)
    worksheet.write('I4', chineseModels)
    worksheet.write('I5', f"{chineseModels/totalModels:.2%}")

    worksheet.write('I8', totalLevels)
    worksheet.write('I9', chineseLevels)
    worksheet.write('I10', f"{chineseLevels/totalLevels:.2%}")

    worksheet.write('I13', totalLevels + totalModels)
    worksheet.write('I14', chineseLevels + chineseModels)
    worksheet.write('I15', f"{(chineseLevels + chineseModels)/(totalLevels + totalModels):.2%}")


    workbook.close()

KEY = config('STEAM_API_KEY')
steam = Steam(KEY)
url = f"https://api.steampowered.com/ISteamRemoteStorage/GetPublishedFileDetails/v1/"   
        
#region ChromeDriver 
options = Options()
# options.add_argument("--headless")
options.add_argument("--disable-gpu")
options.add_argument("--window-size=1920,1080")
options.add_argument("--log-level=3")
base_dir = os.path.dirname(os.path.abspath(sys.argv[0]))
chrome_driver_path = os.path.join(base_dir, "chromedriver.exe")
print(f"Looking for ChromeDriver at {chrome_driver_path}")
if not os.path.exists(chrome_driver_path):
    print("ChromeDriver not found. Please download the latest version of ChromeDriver from https://sites.google.com/chromium.org/driver/ and place it in the same directory as this script.")
    input("Press Enter to close the program...")
    sys.exit(1)
webdriver_service = Service(chrome_driver_path)
driver = webdriver.Chrome(service=webdriver_service, options=options)
wait = WebDriverWait(driver, 3)
#endregion

start_date, end_date, week = user_define_date_range()
filter = user_define_filter()
link = get_workshop_link(start_date, end_date, filter)
print(f'\n\nScanning {filter} from {start_date} to {end_date} (Week {week})...')
driver.get(link)

expected_number_of_items = get_expected_number_of_items()
workshop_data = []

while len(workshop_data) < expected_number_of_items:
    for item in create_workshop_item_objects_array(get_workshop_css_elements()):
        workshop_data.append(item)
    print(len(workshop_data), expected_number_of_items)
    next_page()
print(f"Scanned {len(workshop_data)} items.")
write_to_excel(start_date, end_date, week, workshop_data)
for item in workshop_data:
    print(f"{item.title} by {item.creator_name} ({item.country})")
write_to_excel(start_date, end_date, week, workshop_data)
input("Press Enter to continue...")
# workshop_data = ExtractWorkShopData()
# output_to_excel(workshop_data)


